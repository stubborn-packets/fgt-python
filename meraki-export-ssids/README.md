# Export all Meraki network SSIDs into CSV

Let's expand on our previous example of pulling the SSID information for a single network and exporting that to the console. This time, we are going to export all of the SSID information for every network into a CSV file. 

This can be very useful if you're working on building out a Meraki solution for a customer and you want to document all networks and SSID information by site for the customer. Likewise, you might be working for a single company with a bunch of networks "sites" and you want to have a point in time document for the network state. Either way, this could be useful at some point.

Below are some links that will be helpful to you if you wish to learn more about the Meraki SDK, DevNet Sandbox and the Meraki API documentation

Meraki Github [https://github.com/meraki](https://github.com/meraki)
PyPi Meraki [https://pypi.org/project/meraki/#description](https://pypi.org/project/meraki/#description)
DevNet Sandbox [https://developer.cisco.com/site/sandbox/](https://developer.cisco.com/site/sandbox/)
Meraki API Documentation [https://developer.cisco.com/meraki/api-v1/](https://developer.cisco.com/meraki/api-v1/)

***Full script: meraki-export-ssids.py***

## Lab Overview

In this lab we are going query all the networks that are associated with the specified Org ID and gather all the SSIDs that are attached to each network. Then we are going to take that information and export it to a CSV file for network documentation. 

As before, to accomplish this I’m going to use the Read Only account in the Meraki DevNet Sandbox. The login information and API key can be found once you login to the [Cisco Developer website]([https://developer.cisco.com/](https://developer.cisco.com/)).

As the login information could change, I’m storing the API key in a separate file called 'env.py' and importing that into my working file. All you need to get started is an API key from the DevNet Sandbox or your own Meraki environment. Here is a link to the documentation for obtaining your Meraki API key for your own Meraki evironment. 

[https://developer.cisco.com/meraki/api-v1/#!authorization](https://developer.cisco.com/meraki/api-v1/#!authorization)

## Preparation

To start working with the Meraki SDK we need to install the module which we can do very easily using PIP in our virtual environment. 
```
pip install meraki
```

Next let's create our base CSV file that we are going to be exporting the data to as well as the column fields and I'm going to name it 'ssid-export.csv'. 
```
touch ssid-export.csv
```
Let's open that .csv file in VScode and write out the fields that we are going to be exporting
```
ORG_ID,NETWORK_ID,SSID,PASSWORD,ENABLED,IP_ASSIGNMENT,VISABLE

```
I am leaving a blank line so when we start writing the data it starts on line two instead of continuing on the first line. 

Let's moving into the code

## Show me the 200's (OK)

To start let's create a new file named 'meraki-export-ssids.py' and import all the modules that we need for this lab.
```
import csv
import meraki
from rich import print as rprint
from env import API_KEY, ORG_ID
```
- import csv - this allows to use read and write to a CSV file. This is a built-in module from Python so we don't need to install it. For our use in this lab, we are going to use the write function.
- import meraki - this is the SDK which handles all the backend connection handling so we don’t need to
- from rich import print as rprint - not needed but does make things look nicer in the console when testing.
- from env import API_KEY and ORG_ID - these are the environment variables which have been provided from the Cisco DevNet Sandbox

We are going to be working with the DashboardAPI again in this lab, so let's create the primary function needed which stores our API Key. I'm so going to declare the CSV file that we are going to be writing to
'''
DASHBOARD = meraki.DashboardAPI(API_KEY)
CSV_FILE = 'ssid-export.csv'
'''

Now to make some of this code reusable I'm going to declare 3 different functions:
1. get_networks(orgID) - which is going to take in an Organization ID and return all the Network ID's that have wireless appliances in them. Not all Networks are going to have wireless so no need to include those.
2. get_network_info(netIds) - this function is going to take in a list of Network ID's generated by the above function and get the SSID information for each network. Once the SSID information has been found, it is going to break up the required SSID information into a list and send that off to the CSV writter function.
3. csv_writer(data) - this function takes in a list of data generated from the get_network_info() function and writes it to a CSV file. 

### get_networks(orgID)
Let's get started on the first function, get_networks().

Let's define the function name and say it's going to take in 1 variable, OrgID. Next we are going to create a call to the Meraki Dashboard and search for all the Network ID's that are associated with the Organization ID. 
```
def get_networks(orgId):
    org_response = DASHBOARD.organizations.getOrganizationNetworks(orgId)
```
This will give us a nice list of dictionary objects which we are going to assign to the variable org_response. Below is a sample of one of the dictionary objects in that list
```
{
    'id': 'N_646829496481189507',
    'organizationId': '549236',
    'name': 'CLUS-22',
    'productTypes': ['camera'],
    'timeZone': 'America/Los_Angeles',
    'tags': [],
    'enrollmentString': None,
    'url': 'https://n149.meraki.com/CLUS-22/n/yRKR8cvc/manage/usage/list',
    'notes': None,
    'isBoundToConfigTemplate': False
}
```
As you can see this gives us a lot of good information about each network. Depending on how many networks you have this could only be one or several hundred. 

Next we are going to initialize an empty list called all_networks which is going to be the list object for all the Network ID's that we want to find SSID information for. 

```
all_networks = []
```
In order to populate that list, we are going to create a for loop to iterate through all of the Networks. Within that for loop we are going to do an if statement to validate if the productType key lists wireless. As with the example output above, not all Networks are going to have wireless so no needed to include them in the list. ***If you don't, you will get an API error stating that the command only looks at wireless objects.***. As the productTypes value is a list object, we will need to iterate through that list and if it finds a match then it will add the id key value to the all_networks list.
```
    for network in org_response:
        for products in network['productTypes']:
            if products == 'wireless':
                all_networks.append(network['id'])
```
Finally we are going to return the all_networks list object so that it can be used in other functions. 

Here is what the function will looks like when completed.
```
def get_networks(orgId):
    """going to take in an Organization ID and return all the Network ID's that have 
    wireless appliances in them"""
    org_response = DASHBOARD.organizations.getOrganizationNetworks(orgId)
    # Create a list object of all Network ID's assocaited to the Org ID
    all_networks = []
    for network in org_response:
        for products in network['productTypes']:
            if products == 'wireless':
                all_networks.append(network['id'])
    return all_networks
```
### get_network_info(netIds)
Now that we have a list of all the Network ID's that have wireless in them, let's start the fun part of looking into each Network ID and find all of the SSID's on that network.

To do that, lets define another function called get_network_info(netIds) and it's going to take in a list variable of netIds. 
```
def get_network_info(netIds):
```
As this is a list of string values, we will need to iterate through each one of them and find out all the SSIDs that have been created on it. To do this, we are going to use our friend the for loop again. 
In the for loop, we are going to make another DashboardAPI call to Meraki and looks for the SSIDs for a given Network ID. I'm going to save this response to the variable net_response.

```
for netId in netIds:
        net_response = DASHBOARD.wireless.getNetworkWirelessSsids(netId)
```
Still within the for loop I'm going to initialize another list object called ssid_data. This list is going to hold all the data that I want to write to the CSV file for each SSID.  
```
ssid_data = []
```
Now that we have a list of all the SSIDs for a specific Network ID, let's pull out that data that we want to write to our CSV. As a Network ID can have multiple SSIDs this is going to be another list object so we are going to nest in another for loop to going through each SSID individually. 
Within that for loop I'm going to assign different objects of the SSID output to variables which I'm going to send to be written to CSV. What I'm looking for is:
- Org ID
- SSID Name
- If Enabled
- IP Address Assignment Type
- If Visible
- Password (if there is one)
As this is just a dictionary, we can call the keys and the value will be return to the assigned variable. Just like in the previous Meraki example if the authType is open there is no key for 'psk' which holds the password. So you need to next in an if statement to filter for that. 
```
name = ssid['name']
enabled = ssid['enabled']
ipAssign = ssid['ipAssignmentMode']
visible = ssid['visible']
if ssid['authMode'] == 'open':
    password = 'Open - No Password'
elif ssid['authMode'] == 'psk':
    password = ssid['psk']
else:
    password = "Unknown"
```
With the variables now having the data we want, we can now populate the ssid_data list object and send that off to the csv_writer function
```
ssid_data = [ORG_ID, netId, name, password, enabled, ipAssign, visible]
csv_writer(ssid_data)
```

Here is the full function
```
def get_network_info(netIds):
    """this function is going to take in a list of Network ID's generated by the above function and 
    get the SSID information for each network. Once the SSID information has been found, it is going 
    to break up the required SSID information into a list and send that off to the CSV writter function."""
    for netId in netIds:
        net_response = DASHBOARD.wireless.getNetworkWirelessSsids(netId)
        
        ssid_data = []
        for ssid in net_response:
            name = ssid['name']
            enabled = ssid['enabled']
            ipAssign = ssid['ipAssignmentMode']
            visible = ssid['visible']
            if ssid['authMode'] == 'open':
                password = 'Open - No Password'
            elif ssid['authMode'] == 'psk':
                password = ssid['psk']
            else:
                password = "Unknown"
            ssid_data = [ORG_ID, netId, name, password, enabled, ipAssign, visible]
            csv_writer(ssid_data)

```

### csv_writer(data)
Now to the final piece of the puzzle, let's write the data that we have to a CSV file. As this function is nested within a for loop, it will be ran for each SSID. 
As always, let's define the function and say it's going to take in a list of data to write.
```
def csv_writer(data):
    """this function takes in a list of data generated from the get_network_info() function and 
    writes it to a CSV file"""
```
As this function is going to be called multiple times we want to make sure that as it's opening the external CSV file that it is always being close to prevent corruption of the file. To assist with this, we are going to use a Context Manager. 
```
with open(CSV_FILE, mode='a') as f:
    csvwriter = csv.writer(f)
    csvwriter.writerow(data)
```
Remember in the first part of the script we already declared the variable for CSV_FILE which assigned the 'ssid-export.csv' to it. Now we are just going to open that file in append mode 'a' and assign that to the variable 'f'. Next using the csv module, we are going to assign the writer function to csvwriter and say that it's going to use the Context Manager. And lastly, we are going to use that csvwriter method and call the writerow function passing in the data that we passed into the function. 

### __name == __main__
Now that we have all of our functions created, lets finish it up
```
if __name__ == "__main__":
    network_data = get_networks(ORG_ID)
    get_network_info(network_data)
```
The if __name__ == ""__main__" is making sure that the below will only run if this script is executed. If the functions are imported into another script they will not run. 
I am first going to call the get_networks() function and pass in the ORG_ID which was imported from my 'env.py' file. I'm going to assign that to the variable network_data.
Next I'm going to call the get_network_info() function and pass in the data that was returned from the get_networks function which we assigned network_data. 

If all goes according to plan, you should see a bunch of lines printed out to the console from the Meraki API
```
2022-12-12 11:41:46       meraki:     INFO > GET https://api.meraki.com/api/v1/networks/L_646829496481112606/wireless/ssids
2022-12-12 11:41:46       meraki:     INFO > wireless, getNetworkWirelessSsids - 200 OK
...
```
Once that is compelted, go check your CSV file and you should have a good amount of information in there. When I ran this I came back with 375 SSID's. 
```
ORG_ID,NETWORK_ID,SSID,PASSWORD,ENABLED,IP_ASSIGNMENT,VISABLE
549236,L_646829496481105433,DevNet Sandbox ALWAYS ON - wirel,Open - No Password,True,NAT mode,True
549236,L_646829496481105433,TEST,DevNetMegaAPI4ever,True,NAT mode,True
549236,L_646829496481105433,Réseau invité,Open - No Password,True,NAT mode,True
549236,L_646829496481105433,Unconfigured SSID 4,Open - No Password,False,NAT mode,True
549236,L_646829496481105433,Unconfigured SSID 5,Open - No Password,False,NAT mode,True
```

***Full script: meraki-export-ssids.py***

## Final Thoughts

That was a little longer script and their hundreds of ways to write this, but I thought it was the easiest to explain and get people running. It is amazing how just an hour or so of coding and you can export a bunch of data which would've taken hours and hours of tedious work. 
